# Makefile â€” auditmesh (Fase 3)
SHELL := /bin/bash
ARTIFACTS := artifacts

.PHONY: all audit sbom vulns sast secrets iac k8s activity clean

all: audit

.PHONY: docs
audit: sbom vulns sast secrets iac k8s activity docs

docs:
	@echo "ðŸ§ª Generando badges + summary para docs/"
	python3 tools/badges.py || true

audit: sbom vulns sast secrets iac k8s activity
	@echo "âœ… AuditorÃ­a completa. Artefactos en $(ARTIFACTS)/"

$(ARTIFACTS):
	mkdir -p $(ARTIFACTS)

sbom: $(ARTIFACTS)
	@echo "ðŸ§¾ Generando SBOM (SPDX)â€¦"
	syft . -o spdx-json=$(ARTIFACTS)/sbom.spdx.json

vulns: $(ARTIFACTS)/sbom.spdx.json
	@echo "ðŸ›¡ï¸  Escaneando vulnerabilidades desde SBOMâ€¦"
	grype sbom:$(ARTIFACTS)/sbom.spdx.json -o json > $(ARTIFACTS)/vulns.grype.json || true

sast: $(ARTIFACTS)
	@echo "ðŸ” SAST (Semgrep)â€¦"
	semgrep scan --config auto --sarif -o $(ARTIFACTS)/semgrep.sarif || true

secrets: $(ARTIFACTS)
	@echo "ðŸ”‘ Secret scanning (Gitleaks)â€¦"
	gitleaks detect -s . -f sarif -r $(ARTIFACTS)/gitleaks.sarif || true

iac: $(ARTIFACTS)
	@echo "ðŸ—ï¸  IaC policies (Checkov)â€¦"
	checkov -d . -o json > $(ARTIFACTS)/checkov.json || true

k8s: $(ARTIFACTS)
	@echo "â˜¸ï¸  K8s (Kubescape, si hay manifiestos)â€¦"
	test -d k8s && kubescape scan framework nsa --format json --output $(ARTIFACTS)/kubescape.json ./k8s || true

activity: $(ARTIFACTS)
	@echo "ðŸ“ˆ MÃ©tricas de actividad (git)â€¦"
	@DEFAULT_BRANCH=$$(git symbolic-ref --short refs/remotes/origin/HEAD | cut -d'/' -f2); \
	TZ=Europe/Madrid git log "origin/$$DEFAULT_BRANCH" --date=iso-strict-local -1 --format='%cI %h %an: %s' > $(ARTIFACTS)/last_commit.txt; \
	git rev-list --count --no-merges "origin/$$DEFAULT_BRANCH" > $(ARTIFACTS)/commits_main.txt; \
	TZ=Europe/Madrid git log --date=format:'%Y-%m' --format='%ad' "origin/$$DEFAULT_BRANCH" | sort | uniq -c | sort -nr > $(ARTIFACTS)/commits_by_month.txt
	@python3 tools/audit_summary.py --write-md $(ARTIFACTS)/summary.md || true

clean:
	rm -rf $(ARTIFACTS)

	
